# TLS Notes

## WARNING

#### This guide aims to be complete and also serve as a record of creation for the actual certificates and keys that Vaultron uses. Note also that these certificates and keys are for development and experimentation only. DO NOT USE FOR ANY OTHER PURPOSE

This directory contains a set of TLS certificates and keys which were generated by the [Vault PKI Secrets Engine](https://www.vaultproject.io/docs/secrets/pki/index.html). These are the very certificates and keys which are used for end to end mutual TLS as folows:

- Consul server cluster <-> Consul client agents
- Consul client agents <-> Vault servers
- Vault server <-> Vault client

The subdirectories and their contents are organized as follows:

The Terraform templates automatically include TLS configuration for Consul and Vault in all versions from v0.9.0 on.

## Process

The certificates and keys are generated by Vault acting as both Root CA and Intermediate CA per the PKI Secrets Engine documentation.

Vaultron already enables these PKI Secrets Engine configurations:

```
$ vault secrets list | grep pki
vaultron-root-int/             pki          pki_0b742197          Vaultron example PKI secrets engine (for int CA)
vaultron-root-pki/             pki          pki_6e0c68f1          Vaultron example PKI secrets engine (for root CA)
```

So enabling those mounts beforehand is not necessary.

The steps described below are precisely taken to generate the actual certificates and keys in use by Vaultron.

## Tune The Secrets Engine Root CA Mount

Let's make it possible to issue root certificates that can last for at least 2083 days as opposed to Vault's default 30 day TTL.

Tune the Root CA secrets engine mount:

```
$ vault secrets tune \
  -max-lease-ttl=50000h \
  vaultron-root-pki
Success! Tuned the secrets engine at: vaultron-root-pki/
```

## Root CA

The following steps establish a Root CA for Vaultron.

### Root CA Certificate

Generate a CA certificate and key for the Root CA:

```
$ vault write vaultron-root-pki/root/generate/exported \
  common_name=node.arus.consul \
  ttl=50000h \
  organization="Vaultron Lab" \
  country="United States of America" \
  locality="Kittyhawk" \
  province="Outer Banks" \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vaultron-root-ca-cert.pem"} /RSA/ {out="vaultron-root-ca-key.pem"} { print > out }'
```

### Configure URLs

```
$ vault write vaultron-root-pki/config/urls \
  issuing_certificates="http://127.0.0.1:8200/v1/pki/ca" \
  crl_distribution_points="http://127.0.0.1:8200/v1/pki/crl"
Success! Data written to: vaultron-root-pki/config/urls
```

### Configure Role

This Root CA role provides for generating certificates with a **1750 day lifespan**:

```
$ vault write vaultron-root-pki/roles/vaultron-consul-root \
  allow_localhost=true \
  allowed_domains=arus.consul,sura.consul \
  allow_subdomains=true \
  allow_bare_domains=true \
  allow_glob_domains=true \
  allow_ip_sans=true \
  generate_lease=true \
  organization="Vaultron Lab" \
  country="United States of America" \
  locality="Kittyhawk" \
  province="Outer Banks" \
  max_ttl=42000h
Success! Data written to: vaultron-root-pki/roles/vaultron-consul-root
```

### Generate Certificate from Root CA

Normally you'll want to generate certificates from the Intermediate CA and not the Root CA directly, but if you have a specific need, then using the role created above, here is an example certificate generation command:

```
$ vault write vaultron-root-pki/issue/vaultron-consul-root \
    common_name=tacotown.node.arus.consul
```

Since this is just a verification, the output is omitted.

## Intermediate CA

The following steps establish an Intermediate CA for Vaultron.

### Tune The Secrets Engine Intermediate CA Mount

Let's make it possible to issue root certificates that can last for at least **2083 days** as opposed to Vault's default 30 day TTL.

Tune the Intermediate CA secrets engine mount:

```
$ vault secrets tune \
  -max-lease-ttl=50000h \
  vaultron-int-pki
Success! Tuned the secrets engine at: vaultron-int-pki/
```

### Intermediate CA Certificate Signing Request

We generate a certificate signing request with **1750 day TTL**:

```
$ vault write \
  vaultron-int-pki/intermediate/generate/exported \
  common_name=node.arus.consul \
  ttl=42000h \
  -format=json \
  | jq -r '.data.csr + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vaultron-int-csr.pem"} /RSA/ {out="vaultron-int-ca-key.pem"} { print > out }'
```

### Sign Intermediate CA with Root CA

We sign the Intermediate CA specifying a 1750 day TTL. This is the maximum all certificates issued from the Intermediate can have. (4.7 years)

```
$ vault write \
  vaultron-root-pki/root/sign-intermediate \
  csr=@vaultron-int-csr.pem \
  format=pem_bundle \
  ttl=42000h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.issuing_ca' \
  | awk '/CERTIFICATE/ {out="vaultron-intermediate-signed.pem"} { print > out }'
```

Now, set the intermediate certificate authority's signing certificate to the root-signed certificate:

```
$ vault write \
  vaultron-int-pki/intermediate/set-signed \
  certificate=@vaultron-intermediate-signed.pem
Success! Data written to: vaultron-int-pki/intermediate/set-signed
```

### Configure URLs

```
$ vault write \
  vaultron-int-pki/config/urls \
  issuing_certificates="http://127.0.0.1:8200/v1/pki_int/ca" \
  crl_distribution_points="http://127.0.0.1:8200/v1/pki_int/crl"
Success! Data written to: vaultron-int-pki/config/urls
```

### Configure a Role

The role has a maximum TTL of 1750 days:

```
$ vault write vaultron-int-pki/roles/vaultron-int \
  allow_subdomains=true \
  allowed_domains=arus.consul,node.arus.consul,node.sura.consul,node.consul,service.consul \
  allow_bare_domains=true \
  allow_glob_domains=true \
  allow_ip_sans=true \
  allow_localhost="true" \
  generate_lease=true \
  organization="Vaultron Lab" \
  country="United States of America" \
  locality="Kittyhawk" \
  province="Outer Banks" \
  max_ttl=42000h \
  ttl=42000h
Success! Data written to: vaultron-int-pki/roles/vaultron-int
```

#### Confirm Role

Ensure the role is correct:

```
$ vault read vaultron-int-pki/roles/vaultron-int
Key                                   Value
---                                   -----
allow_any_name                        false
allow_bare_domains                    true
allow_glob_domains                    true
allow_ip_sans                         true
allow_localhost                       true
allow_subdomains                      true
allow_token_displayname               false
allowed_domains                       [arus.consul node.arus.consul node.sura.consul node.consul service.consul]
allowed_other_sans                    <nil>
allowed_serial_numbers                []
allowed_uri_sans                      []
basic_constraints_valid_for_non_ca    false
client_flag                           true
code_signing_flag                     false
country                               [United States of America]
email_protection_flag                 false
enforce_hostnames                     true
ext_key_usage                         []
ext_key_usage_oids                    []
generate_lease                        true
key_bits                              2048
key_type                              rsa
key_usage                             [DigitalSignature KeyAgreement KeyEncipherment]
locality                              [Kittyhawk]
max_ttl                               42000h
no_store                              false
not_before_duration                   30s
organization                          [Vaultron Lab]
ou                                    []
policy_identifiers                    []
postal_code                           []
province                              [Outer Banks]
require_cn                            true
server_flag                           true
street_address                        []
ttl                                   42000h
use_csr_common_name                   true
use_csr_sans                          true
```

## Issue Certificates

Vaultron uses Docker with some predictable address spaces and we will issue a certificate per container, but this is not really necessary since the IP SANs will be for ranged address space of Vaultron (172.17.0.1-172.17.0.20 and 100.115.92.200-100.115.92.220 for ChromeOS) anyway and the certificates could be shared/interchangeable since they're not for a specific IP or FQDN. We also allow loopback IP.

While this is kind of gross, it is all to secure a sandbox or playground deployment as a conceptual feature.

### Whyeeeee?

This is made difficult due to the desire to support Docker for Mac which does not yet offer a network bridge or IPs assigned to containers, which makes specificity on IP SANs currently unpossible! :sad_panda:

## Vault Server

Let's make certificates for the Vault servers; we'll use a 21000h/875 day TTL for all of them:

```
$ vault write \
  vaultron-int-pki/issue/vaultron-int \
  common_name=vaults0.node.arus.consul \
  alt_names=active.vault.service.consul,standby.vault.service.consul,vault.service.consul,vaults0.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,172.17.0.1,172.17.0.2,172.17.0.3,172.17.0.4,172.17.0.5,172.17.0.6,172.17.0.7,172.17.0.8,172.17.0.9,172.17.0.10,172.17.0.11,172.17.0.12,172.17.0.13,172.17.0.14,172.17.0.15,172.17.0.16,172.17.0.17,172.17.0.18,172.17.0.19,172.17.0.20,100.115.92.200,100.115.92.201,100.115.92.202,100.115.92.203,100.115.92.204,100.115.92.205,100.115.92.206,100.115.92.207,100.115.92.208,100.115.92.209,100.115.92.210,100.115.92.211,100.115.92.212,100.115.92.213,100.115.92.214,100.115.92.215,100.115.92.216,100.115.92.217,100.115.92.218,100.115.92.219,100.115.92.220" \
  ttl=21000h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vault-server-0.crt"} /RSA/ {out="vault-server-0.key"} { print > out }'
```

```
$ vault write \
  vaultron-int-pki/issue/vaultron-int \
  common_name=vaults1.node.arus.consul \
  alt_names=vaults1.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,172.17.0.1,172.17.0.2,172.17.0.3,172.17.0.4,172.17.0.5,172.17.0.6,172.17.0.7,172.17.0.8,172.17.0.9,172.17.0.10,172.17.0.11,172.17.0.12,172.17.0.13,172.17.0.14,172.17.0.15,172.17.0.16,172.17.0.17,172.17.0.18,172.17.0.19,172.17.0.20,100.115.92.200,100.115.92.201,100.115.92.202,100.115.92.203,100.115.92.204,100.115.92.205,100.115.92.206,100.115.92.207,100.115.92.208,100.115.92.209,100.115.92.210,100.115.92.211,100.115.92.212,100.115.92.213,100.115.92.214,100.115.92.215,100.115.92.216,100.115.92.217,100.115.92.218,100.115.92.219,100.115.92.220" \
  ttl=21000h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vault-server-1.crt"} /RSA/ {out="vault-server-1.key"} { print > out }'
```

```
$ vault write \
  vaultron-int-pki/issue/vaultron-int \
  common_name=vaults2.node.arus.consul \
  alt_names=vaults2.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,172.17.0.1,172.17.0.2,172.17.0.3,172.17.0.4,172.17.0.5,172.17.0.6,172.17.0.7,172.17.0.8,172.17.0.9,172.17.0.10,172.17.0.11,172.17.0.12,172.17.0.13,172.17.0.14,172.17.0.15,172.17.0.16,172.17.0.17,172.17.0.18,172.17.0.19,172.17.0.20,100.115.92.200,100.115.92.201,100.115.92.202,100.115.92.203,100.115.92.204,100.115.92.205,100.115.92.206,100.115.92.207,100.115.92.208,100.115.92.209,100.115.92.210,100.115.92.211,100.115.92.212,100.115.92.213,100.115.92.214,100.115.92.215,100.115.92.216,100.115.92.217,100.115.92.218,100.115.92.219,100.115.92.220" \
  ttl=21000h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vault-server-2.crt"} /RSA/ {out="vault-server-2.key"} { print > out }'
```

## Consul Servers

Let's make certificates for the Consul servers; we'll use a 21000h/875 day TTL for all of them:

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=consuls0.node.arus.consul \
  alt_names=consul.service.consul,consuls0.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,172.17.0.1,172.17.0.2,172.17.0.3,172.17.0.4,172.17.0.5,172.17.0.6,172.17.0.7,172.17.0.8,172.17.0.9,172.17.0.10,172.17.0.11,172.17.0.12,172.17.0.13,172.17.0.14,172.17.0.15,172.17.0.16,172.17.0.17,172.17.0.18,172.17.0.19,172.17.0.20,100.115.92.200,100.115.92.201,100.115.92.202,100.115.92.203,100.115.92.204,100.115.92.205,100.115.92.206,100.115.92.207,100.115.92.208,100.115.92.209,100.115.92.210,100.115.92.211,100.115.92.212,100.115.92.213,100.115.92.214,100.115.92.215,100.115.92.216,100.115.92.217,100.115.92.218,100.115.92.219,100.115.92.220" \
  ttl=21000h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="consul-server-0.crt"} /RSA/ {out="consul-server-0.key"} { print > out }'
```

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=consuls1.node.arus.consul \
  alt_names=consul.service.consul,consuls1.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,172.17.0.1,172.17.0.2,172.17.0.3,172.17.0.4,172.17.0.5,172.17.0.6,172.17.0.7,172.17.0.8,172.17.0.9,172.17.0.10,172.17.0.11,172.17.0.12,172.17.0.13,172.17.0.14,172.17.0.15,172.17.0.16,172.17.0.17,172.17.0.18,172.17.0.19,172.17.0.20,100.115.92.200,100.115.92.201,100.115.92.202,100.115.92.203,100.115.92.204,100.115.92.205,100.115.92.206,100.115.92.207,100.115.92.208,100.115.92.209,100.115.92.210,100.115.92.211,100.115.92.212,100.115.92.213,100.115.92.214,100.115.92.215,100.115.92.216,100.115.92.217,100.115.92.218,100.115.92.219,100.115.92.220" \
  ttl=21000h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="consul-server-1.crt"} /RSA/ {out="consul-server-1.key"} { print > out }'
```

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=consuls2.node.arus.consul \
  alt_names=consul.service.consul,consuls2.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,172.17.0.1,172.17.0.2,172.17.0.3,172.17.0.4,172.17.0.5,172.17.0.6,172.17.0.7,172.17.0.8,172.17.0.9,172.17.0.10,172.17.0.11,172.17.0.12,172.17.0.13,172.17.0.14,172.17.0.15,172.17.0.16,172.17.0.17,172.17.0.18,172.17.0.19,172.17.0.20,100.115.92.200,100.115.92.201,100.115.92.202,100.115.92.203,100.115.92.204,100.115.92.205,100.115.92.206,100.115.92.207,100.115.92.208,100.115.92.209,100.115.92.210,100.115.92.211,100.115.92.212,100.115.92.213,100.115.92.214,100.115.92.215,100.115.92.216,100.115.92.217,100.115.92.218,100.115.92.219,100.115.92.220" \
  ttl=21000h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="consul-server-2.crt"} /RSA/ {out="consul-server-2.key"} { print > out }'
```

## Consul Clients

Let's make certificates for the Consul clients; we'll use a 21000h/875 day TTL for all of them:

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=consulc0.node.arus.consul \
  alt_names=consul.service.consul,consulc0.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,172.17.0.1,172.17.0.2,172.17.0.3,172.17.0.4,172.17.0.5,172.17.0.6,172.17.0.7,172.17.0.8,172.17.0.9,172.17.0.10,172.17.0.11,172.17.0.12,172.17.0.13,172.17.0.14,172.17.0.15,172.17.0.16,172.17.0.17,172.17.0.18,172.17.0.19,172.17.0.20,100.115.92.200,100.115.92.201,100.115.92.202,100.115.92.203,100.115.92.204,100.115.92.205,100.115.92.206,100.115.92.207,100.115.92.208,100.115.92.209,100.115.92.210,100.115.92.211,100.115.92.212,100.115.92.213,100.115.92.214,100.115.92.215,100.115.92.216,100.115.92.217,100.115.92.218,100.115.92.219,100.115.92.220" \ttl=21000h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="consul-client-0.crt"} /RSA/ {out="consul-client-0.key"} { print > out }'
```

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=consulc1.node.arus.consul \
  alt_names=consul.service.consul,consulc1.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,172.17.0.1,172.17.0.2,172.17.0.3,172.17.0.4,172.17.0.5,172.17.0.6,172.17.0.7,172.17.0.8,172.17.0.9,172.17.0.10,172.17.0.11,172.17.0.12,172.17.0.13,172.17.0.14,172.17.0.15,172.17.0.16,172.17.0.17,172.17.0.18,172.17.0.19,172.17.0.20,100.115.92.200,100.115.92.201,100.115.92.202,100.115.92.203,100.115.92.204,100.115.92.205,100.115.92.206,100.115.92.207,100.115.92.208,100.115.92.209,100.115.92.210,100.115.92.211,100.115.92.212,100.115.92.213,100.115.92.214,100.115.92.215,100.115.92.216,100.115.92.217,100.115.92.218,100.115.92.219,100.115.92.220" \
  ttl=21000h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="consul-client-1.crt"} /RSA/ {out="consul-client-1.key"} { print > out }'
```

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=consulc2.node.arus.consul \
  alt_names=consul.service.consul,consulc2.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,172.17.0.1,172.17.0.2,172.17.0.3,172.17.0.4,172.17.0.5,172.17.0.6,172.17.0.7,172.17.0.8,172.17.0.9,172.17.0.10,172.17.0.11,172.17.0.12,172.17.0.13,172.17.0.14,172.17.0.15,172.17.0.16,172.17.0.17,172.17.0.18,172.17.0.19,172.17.0.20,100.115.92.200,100.115.92.201,100.115.92.202,100.115.92.203,100.115.92.204,100.115.92.205,100.115.92.206,100.115.92.207,100.115.92.208,100.115.92.209,100.115.92.210,100.115.92.211,100.115.92.212,100.115.92.213,100.115.92.214,100.115.92.215,100.115.92.216,100.115.92.217,100.115.92.218,100.115.92.219,100.115.92.220" \
  ttl=21000h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="consul-client-2.crt"} /RSA/ {out="consul-client-2.key"} { print > out }'
```

## Create Grafana Certificate

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=grafana.node.arus.consul \
  alt_names=grafana.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,172.17.0.1,172.17.0.2,172.17.0.3,172.17.0.4,172.17.0.5,172.17.0.6,172.17.0.7,172.17.0.8,172.17.0.9,172.17.0.10,172.17.0.11,172.17.0.12,172.17.0.13,172.17.0.14,172.17.0.15,172.17.0.16,172.17.0.17,172.17.0.18,172.17.0.19,172.17.0.20,100.115.92.200,100.115.92.201,100.115.92.202,100.115.92.203,100.115.92.204,100.115.92.205,100.115.92.206,100.115.92.207,100.115.92.208,100.115.92.209,100.115.92.210,100.115.92.211,100.115.92.212,100.115.92.213,100.115.92.214,100.115.92.215,100.115.92.216,100.115.92.217,100.115.92.218,100.115.92.219,100.115.92.220" \
  ttl=21000h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="grafana.crt"} /RSA/ {out="grafana.key"} { print > out }'
```

## Create LDAP Certificate

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=ldap.node.arus.consul \
  alt_names=ldap.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,172.17.0.1,172.17.0.2,172.17.0.3,172.17.0.4,172.17.0.5,172.17.0.6,172.17.0.7,172.17.0.8,172.17.0.9,172.17.0.10,172.17.0.11,172.17.0.12,172.17.0.13,172.17.0.14,172.17.0.15,172.17.0.16,172.17.0.17,172.17.0.18,172.17.0.19,172.17.0.20,100.115.92.200,100.115.92.201,100.115.92.202,100.115.92.203,100.115.92.204,100.115.92.205,100.115.92.206,100.115.92.207,100.115.92.208,100.115.92.209,100.115.92.210,100.115.92.211,100.115.92.212,100.115.92.213,100.115.92.214,100.115.92.215,100.115.92.216,100.115.92.217,100.115.92.218,100.115.92.219,100.115.92.220" \
  ttl=21000h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="ldap.crt"} /RSA/ {out="ldap.key"} { print > out }'
```

## Create MongoDB Certificate

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=mongodb.node.arus.consul \
  alt_names=mongodb.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,172.17.0.1,172.17.0.2,172.17.0.3,172.17.0.4,172.17.0.5,172.17.0.6,172.17.0.7,172.17.0.8,172.17.0.9,172.17.0.10,172.17.0.11,172.17.0.12,172.17.0.13,172.17.0.14,172.17.0.15,172.17.0.16,172.17.0.17,172.17.0.18,172.17.0.19,172.17.0.20,100.115.92.200,100.115.92.201,100.115.92.202,100.115.92.203,100.115.92.204,100.115.92.205,100.115.92.206,100.115.92.207,100.115.92.208,100.115.92.209,100.115.92.210,100.115.92.211,100.115.92.212,100.115.92.213,100.115.92.214,100.115.92.215,100.115.92.216,100.115.92.217,100.115.92.218,100.115.92.219,100.115.92.220" \
  ttl=21000h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="mongodb.crt"} /RSA/ {out="mongodb.key"} { print > out }'
```

## Create MySQL Certificate

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=mysql.node.arus.consul \
  alt_names=mysql.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,172.17.0.1,172.17.0.2,172.17.0.3,172.17.0.4,172.17.0.5,172.17.0.6,172.17.0.7,172.17.0.8,172.17.0.9,172.17.0.10,172.17.0.11,172.17.0.12,172.17.0.13,172.17.0.14,172.17.0.15,172.17.0.16,172.17.0.17,172.17.0.18,172.17.0.19,172.17.0.20,100.115.92.200,100.115.92.201,100.115.92.202,100.115.92.203,100.115.92.204,100.115.92.205,100.115.92.206,100.115.92.207,100.115.92.208,100.115.92.209,100.115.92.210,100.115.92.211,100.115.92.212,100.115.92.213,100.115.92.214,100.115.92.215,100.115.92.216,100.115.92.217,100.115.92.218,100.115.92.219,100.115.92.220" \
  ttl=21000h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="mysql.crt"} /RSA/ {out="mysql.key"} { print > out }'
```

## Create PostgreSQL Certificate

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=postgresql.node.arus.consul \
  alt_names=postgresql.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,172.17.0.1,172.17.0.2,172.17.0.3,172.17.0.4,172.17.0.5,172.17.0.6,172.17.0.7,172.17.0.8,172.17.0.9,172.17.0.10,172.17.0.11,172.17.0.12,172.17.0.13,172.17.0.14,172.17.0.15,172.17.0.16,172.17.0.17,172.17.0.18,172.17.0.19,172.17.0.20,100.115.92.200,100.115.92.201,100.115.92.202,100.115.92.203,100.115.92.204,100.115.92.205,100.115.92.206,100.115.92.207,100.115.92.208,100.115.92.209,100.115.92.210,100.115.92.211,100.115.92.212,100.115.92.213,100.115.92.214,100.115.92.215,100.115.92.216,100.115.92.217,100.115.92.218,100.115.92.219,100.115.92.220" \
  ttl=21000h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="postgresql.crt"} /RSA/ {out="postgresql.key"} { print > out }'
```

## Create Prometheus Certificate

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=prometheus.node.arus.consul \
  alt_names=prometheus.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,172.17.0.1,172.17.0.2,172.17.0.3,172.17.0.4,172.17.0.5,172.17.0.6,172.17.0.7,172.17.0.8,172.17.0.9,172.17.0.10,172.17.0.11,172.17.0.12,172.17.0.13,172.17.0.14,172.17.0.15,172.17.0.16,172.17.0.17,172.17.0.18,172.17.0.19,172.17.0.20,100.115.92.200,100.115.92.201,100.115.92.202,100.115.92.203,100.115.92.204,100.115.92.205,100.115.92.206,100.115.92.207,100.115.92.208,100.115.92.209,100.115.92.210,100.115.92.211,100.115.92.212,100.115.92.213,100.115.92.214,100.115.92.215,100.115.92.216,100.115.92.217,100.115.92.218,100.115.92.219,100.115.92.220" \
  ttl=21000h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="prometheus.crt"} /RSA/ {out="prometheus.key"} { print > out }'
```

## CA Certificate Chain

Take the contents of `ca_chain` from any issued certificate/key set above and save as `ca.pem`:

```
-----BEGIN CERTIFICATE-----
MIIEGjCCAwKgAwIBAgIUD6D1k/v7bCe8cxvASkNuy3gtHfgwDQYJKoZIhvcNAQEL
BQAwfzEhMB8GA1UEBhMYVW5pdGVkIFN0YXRlcyBvZiBBbWVyaWNhMRQwEgYDVQQI
EwtPdXRlciBCYW5rczESMBAGA1UEBxMJS2l0dHloYXdrMRUwEwYDVQQKEwxWYXVs
dHJvbiBMYWIxGTAXBgNVBAMTEG5vZGUuYXJ1cy5jb25zdWwwHhcNMTkwNDIzMTU1
MjIwWhcNMjQwMjA2MTU1MjUwWjAbMRkwFwYDVQQDExBub2RlLmFydXMuY29uc3Vs
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuDihbCA1EccE3TCM4jmq
ltiCU5efwRLmyEGFMQOGQBWtkJjdx/WVmHl6a3o83CNnVYGy3iTLbKbKmqBixvPu
/mnsLIaFSX+9YmQO3L+KiExgdM1HnEEgDC76j3NwUZ3u45PhGWP+tSMnpVpGf6Be
V+Znf4mdVNoAIMOQry8OYn/4nluWhbBgNMcBxPeYCPeOwVeXcN5WNLYd2IUIi5Iy
uXJnVmcl8/AyONFvxdy82G7jWIDmbE/0eOWgS0qmdowjxNevIHLJalewJzS6zpdr
5QQ8wuYNeue2XHzLDdQD5RBQvLT32PAFe7krLM61RM+uhLcZhQhwuHZQO3xoUaJC
8QIDAQABo4HxMIHuMA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8EBTADAQH/MB0G
A1UdDgQWBBTuPK0swec6BJc8hL1I+nZXp/ig3DAfBgNVHSMEGDAWgBTe6qNgUw+G
rW20OWmEhyr6PSFV1zA7BggrBgEFBQcBAQQvMC0wKwYIKwYBBQUHMAKGH2h0dHA6
Ly8xMjcuMC4wLjE6ODIwMC92MS9wa2kvY2EwGwYDVR0RBBQwEoIQbm9kZS5hcnVz
LmNvbnN1bDAxBgNVHR8EKjAoMCagJKAihiBodHRwOi8vMTI3LjAuMC4xOjgyMDAv
djEvcGtpL2NybDANBgkqhkiG9w0BAQsFAAOCAQEAI1qAZ4i4MgsreAdLjT4hnIN4
MZNpkdEH769kH+HaNA14YPYSr1AG6kARg0sZ8fk4X4+4BACkOVpdOCH4dgRvae+2
wfodoRk9cn66z8d4QBK03EZSmWsqk67TdtaH4KHA1dgyRQVYOuReggwitRywBCMe
hGuT0pGJHJPDLS2ZYKgr5XGVUXHh/RLladtJUw51neDLosmybI+JORbCKAdGt2x1
beLklmss2ZUcVwcvhiqhnNxOAteRf/muHEs3nbPmasyfRodW7DEmAQTbPuEP0UKZ
lmlm9wd4MibUGgA55jWJGd4ihaGPHVo/Zz6IzEgKYnRNWLl0ZvTyGq3BkB2NnA==
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIEDTCCAvWgAwIBAgIUHZsYsbgZqPm2SMyVh3nNiBMufIkwDQYJKoZIhvcNAQEL
BQAwfzEhMB8GA1UEBhMYVW5pdGVkIFN0YXRlcyBvZiBBbWVyaWNhMRQwEgYDVQQI
EwtPdXRlciBCYW5rczESMBAGA1UEBxMJS2l0dHloYXdrMRUwEwYDVQQKEwxWYXVs
dHJvbiBMYWIxGTAXBgNVBAMTEG5vZGUuYXJ1cy5jb25zdWwwHhcNMTkwNDIzMTU0
MzU4WhcNMjUwMTA0MjM0NDI3WjB/MSEwHwYDVQQGExhVbml0ZWQgU3RhdGVzIG9m
IEFtZXJpY2ExFDASBgNVBAgTC091dGVyIEJhbmtzMRIwEAYDVQQHEwlLaXR0eWhh
d2sxFTATBgNVBAoTDFZhdWx0cm9uIExhYjEZMBcGA1UEAxMQbm9kZS5hcnVzLmNv
bnN1bDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALZAZy2nP/KA0vSQ
n1+U3dxWtplkPD9pD3WgejQaxLBCAIvjCS9AeRaZC9L9XVnEBf1uKXT02uQGLsQ4
Ny043TJI4TFEnX8sWLOUayzbpYmtWXXOn3Fr6aU0GqbUs4Ngd5p550yu3OSGL6Gy
IdpnXtiAgaZ9ppZm8Y+ZPxcrd+LRgIzM+Jlj8O/5vusK86F2/7wcEet7gJCokA27
ckPXfaD1Fz+ckgimUI6Gs7r50LFMc/XkF1Rd9L+UMVbJdNSm8JXFhJEai3brVzwZ
D1/c2y3yo/6OjnC9g69+zECf4T5IgQk6vsOdurVRGpur+iLcsiw3QT3ZHPpeNmjR
Ioaev4kCAwEAAaOBgDB+MA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8EBTADAQH/
MB0GA1UdDgQWBBTe6qNgUw+GrW20OWmEhyr6PSFV1zAfBgNVHSMEGDAWgBTe6qNg
Uw+GrW20OWmEhyr6PSFV1zAbBgNVHREEFDASghBub2RlLmFydXMuY29uc3VsMA0G
CSqGSIb3DQEBCwUAA4IBAQCzZtuidyChju84Gh7Mss9NB4/18r2rkCBlQdcuaYnE
7UNkJohXDAu3KC7r8QfSvwo9WDpS7/hCBIcqRz9jfmgNd2A4w2cveMsWbqHhwSEy
O3lf701iKJZ190tE9jgUGeJ9DlZzm7PO0KKWKjuqHU7M9mgYHJHeFv+8bt10R7kP
cN1EoiYWVNOO10nqtQyolHAjKF1MIxhuvPMlQ/EUliljPSISPLMF0Ufih0l++K+5
K+SnexPXngK4U48JQIDqPmBm68z1PxA1Jw0dJ2hr/6teXYfo1ymSw5PlFehg1dOU
k3ld1i2ax3Yoevh8Atu70kyAfhzenAWySJy9GQ00vsKS
-----END CERTIFICATE-----
```

Use this as the value for `-ca-cert=` or `VAULT_CACERT` or import it into your OS trust store to have all of Vaultron's certificates trusted by default.

## Import into New Vault

### Root CA

Use a PEM bundle containing the certificates and key:

