# TLS Notes

This directory contains a set of TLS certificates and keys which were generated by the [Vault PKI Secrets Engine](https://www.vaultproject.io/docs/secrets/pki/index.html). These are the very certificates and keys which are used for end to end mutual TLS as folows:

- Consul server cluster <-> Consul client agents
- Consul client agents <-> Vault servers
- Vault server <-> Vault client

The subdirectories and their contents are organized as follows:

The Terraform templates automatically include TLS configuration for Consul and Vault in all versions from v0.9.0 on.

## Process

The certificates and keys are generated by Vault acting as both Root CA and Intermediate CA per the PKI Secrets Engine documentation.

Vaultron already enables these PKI Secrets Engine configurations:

```
$vault secrets list
Path                           Type         Description
----                           ----         -----------
...
vaultron_int_pki/              pki          n/a
vaultron_root_pki/             pki          n/a
...
```

So their creation beforehand is not necessary.

### Tune The Mount

Let's make it possible to issue certificates that can last for at least one year as opposed to Vault's default 30 day TTL:

First the Root CA:

```
$ vault secrets tune -max-lease-ttl=8760h vaultron_root_pki
Success! Tuned the secrets engine at: vaultron_root_pki/
```

Then the Intermediate CA:

```
$ vault secrets tune -max-lease-ttl=8760h vaultron_int_pki
Success! Tuned the secrets engine at: vaultron_int_pki/
```

### CA Cert and Key

Generate a CA certificate and key for the Root CA:

```
$ vault write vaultron_root_pki/root/generate/internal \
    common_name=vaultron.consul \
    ttl=8760h
Key              Value
---              -----
certificate      -----BEGIN CERTIFICATE-----
MIIDQTCCAimgAwIBAgIUC+9g/nAXPPV/VG6w50EnOAfc9+owDQYJKoZIhvcNAQEL
BQAwGjEYMBYGA1UEAxMPdmF1bHRyb24uY29uc3VsMB4XDTE4MDMwMjE4MTA0OVoX
DTE5MDMwMjE4MTExOVowGjEYMBYGA1UEAxMPdmF1bHRyb24uY29uc3VsMIIBIjAN
BgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsE9SqeKj7J5TPRonp8isauFcRP2x
P7I0erzRKEqdVejZF69kcdtFMVgJkDDv75rNzpNVlWGGCHSEbSJpvjV6Dv4vQROM
4u4923AgLNawt9lkrfZRD3gmPlN+EQ7x3jFwKaiOeyrRbLmnG6vt5slJrWpx3HfG
dnKIrN7yL0lq+ba+Z6IH0ScrV7HBxYQoLmVChVq2bSFlhs9F+vIY6nRpV99Z4Z/F
fAATKNoiVMyEMFscFciXoojBg1wxqRB3OycpsG5rn15fJBLaQkXHBY2Ge2RtoR4X
1Ad8KQ+BIdELSGb+1hJFRgI1Qya4Dn2r6S3cDex7HurOp9k97I3TFW9G1wIDAQAB
o38wfTAOBgNVHQ8BAf8EBAMCAQYwDwYDVR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQU
K0wt21kA6d8NejaOk87TYnT/OPAwHwYDVR0jBBgwFoAUK0wt21kA6d8NejaOk87T
YnT/OPAwGgYDVR0RBBMwEYIPdmF1bHRyb24uY29uc3VsMA0GCSqGSIb3DQEBCwUA
A4IBAQB8EXaxcll8A1xoOJIo4O+9kytst58CO51+7Tfh5AEybAlv1Mh0bHzwt3Wn
SoC+2z1bGwwilnPFlTMy+pExehBkVqAGyMzu/+0RqEhkFkBPFNUGnajraR7v11Es
errMmtQ723x/AC+zcVo0tvQCbZ1Dq6JjwLiHr6m0cNkdPETodmYveRhYdff8nMS5
KpD4w3R3vXS4gHa4nOuszjwq5B+OEwiY7QMdPPIpzhwZ0Ysou2SYguUq0hfyTtDO
6qFBV7yk0r+B7hjgxkU3pIoPUJa2GqIWR8VmIV4RZJSOJH6+eAkNjIjGvqjvCJeE
Ly9/0vipjKDAxIqEcvGttJzSYFLQ
-----END CERTIFICATE-----
expiration       1551550279
issuing_ca       -----BEGIN CERTIFICATE-----
MIIDQTCCAimgAwIBAgIUC+9g/nAXPPV/VG6w50EnOAfc9+owDQYJKoZIhvcNAQEL
BQAwGjEYMBYGA1UEAxMPdmF1bHRyb24uY29uc3VsMB4XDTE4MDMwMjE4MTA0OVoX
DTE5MDMwMjE4MTExOVowGjEYMBYGA1UEAxMPdmF1bHRyb24uY29uc3VsMIIBIjAN
BgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsE9SqeKj7J5TPRonp8isauFcRP2x
P7I0erzRKEqdVejZF69kcdtFMVgJkDDv75rNzpNVlWGGCHSEbSJpvjV6Dv4vQROM
4u4923AgLNawt9lkrfZRD3gmPlN+EQ7x3jFwKaiOeyrRbLmnG6vt5slJrWpx3HfG
dnKIrN7yL0lq+ba+Z6IH0ScrV7HBxYQoLmVChVq2bSFlhs9F+vIY6nRpV99Z4Z/F
fAATKNoiVMyEMFscFciXoojBg1wxqRB3OycpsG5rn15fJBLaQkXHBY2Ge2RtoR4X
1Ad8KQ+BIdELSGb+1hJFRgI1Qya4Dn2r6S3cDex7HurOp9k97I3TFW9G1wIDAQAB
o38wfTAOBgNVHQ8BAf8EBAMCAQYwDwYDVR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQU
K0wt21kA6d8NejaOk87TYnT/OPAwHwYDVR0jBBgwFoAUK0wt21kA6d8NejaOk87T
YnT/OPAwGgYDVR0RBBMwEYIPdmF1bHRyb24uY29uc3VsMA0GCSqGSIb3DQEBCwUA
A4IBAQB8EXaxcll8A1xoOJIo4O+9kytst58CO51+7Tfh5AEybAlv1Mh0bHzwt3Wn
SoC+2z1bGwwilnPFlTMy+pExehBkVqAGyMzu/+0RqEhkFkBPFNUGnajraR7v11Es
errMmtQ723x/AC+zcVo0tvQCbZ1Dq6JjwLiHr6m0cNkdPETodmYveRhYdff8nMS5
KpD4w3R3vXS4gHa4nOuszjwq5B+OEwiY7QMdPPIpzhwZ0Ysou2SYguUq0hfyTtDO
6qFBV7yk0r+B7hjgxkU3pIoPUJa2GqIWR8VmIV4RZJSOJH6+eAkNjIjGvqjvCJeE
Ly9/0vipjKDAxIqEcvGttJzSYFLQ
-----END CERTIFICATE-----
serial_number    0b:ef:60:fe:70:17:3c:f5:7f:54:6e:b0:e7:41:27:38:07:dc:f7:ea
```

### Configure URLs


```
$ vault write vaultron_root_pki/config/urls \
    issuing_certificates="http://127.0.0.1:8200/v1/pki/ca" \
    crl_distribution_points="http://127.0.0.1:8200/v1/pki/crl"
Success! Data written to: vaultron_root_pki/config/urls
```

### Configure Role

This root role provides for generating certificates with the 1 year lifespan:

```
$ vault write vaultron_root_pki/roles/vaultron_consul_root \
    allow_localhost=true \
    allowed_domains=vaultron.consul \
    allow_subdomains=true \
    allow_bare_domains=true \
    allow_glob_domains=true \
    allow_ip_sans=true \
    generate_lease=true \
    organization="Vaultron Lab" \
    max_ttl=8760h
Success! Data written to: vaultron_root_pki/roles/vaultron_consul_root
```

### Generate Certificate from Root CA

Normally you'll want to generate certificates from the Intermediate CA and not the Root CA directly, but if you have a specific need, then using the role created above, here is an example certificate generation command:

```
vault write vaultron_root_pki/issue/vaultron_consul_root \
    common_name=tacotown.vaultron.consul
Key                 Value
---                 -----
lease_id            vaultron_root_pki/issue/vaultron_consul_root/9f93c52c-0b90-00ee-5354-73a5cc4660af
lease_duration      167h59m59s
lease_renewable     false
certificate         -----BEGIN CERTIFICATE-----
MIID7DCCAtSgAwIBAgIUY0ptoWf3Romca0ouJBcp1iH+4gwwDQYJKoZIhvcNAQEL
BQAwGjEYMBYGA1UEAxMPdmF1bHRyb24uY29uc3VsMB4XDTE4MDMwMjE4MjUwMFoX
DTE4MDMwOTE4MjUzMFowOjEVMBMGA1UEChMMVmF1bHRyb24gTGFiMSEwHwYDVQQD
Exh0YWNvdG93bi52YXVsdHJvbi5jb25zdWwwggEiMA0GCSqGSIb3DQEBAQUAA4IB
DwAwggEKAoIBAQDWKAh1CAhqPD3GKIm75qbPB5fSxBlwwnDCMAbu1W2UqfmaXHnC
InzGOZdS1ohjhiJVciI7tOc9TEUjAndd3uZhBTORSAdTek0tR+Vl3btDokiSIttQ
3IMLpAezriwDykFl7SOqxRh5b1FypE0I92kJE9qiqYNVkXEtWESgmJio/ZooHtQf
xz+wXfdeEE1qZIQOi+7yXB4MqRW/No1h4PnD85c7lGMOFMvgK3jEnp3t9iEV2aVR
rvv7cwIWjfsBzBLisZfQ9md1yLTEpAXTyG5QLuvx4SoeFmyBSjBCd2jzujHgpJxT
aQKFTKkxn8MawREZMczbFmGvWCCXNud9FDoTAgMBAAGjggEIMIIBBDAOBgNVHQ8B
Af8EBAMCA6gwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUFBwMCMB0GA1UdDgQW
BBS+ePgEzO4+lRFs2xXjjscIwMzSojAfBgNVHSMEGDAWgBQrTC3bWQDp3w16No6T
ztNidP848DA7BggrBgEFBQcBAQQvMC0wKwYIKwYBBQUHMAKGH2h0dHA6Ly8xMjcu
MC4wLjE6ODIwMC92MS9wa2kvY2EwIwYDVR0RBBwwGoIYdGFjb3Rvd24udmF1bHRy
b24uY29uc3VsMDEGA1UdHwQqMCgwJqAkoCKGIGh0dHA6Ly8xMjcuMC4wLjE6ODIw
MC92MS9wa2kvY3JsMA0GCSqGSIb3DQEBCwUAA4IBAQCC+mZHI0pV1tZnWe0pQQGJ
9n/VCXz6VXDrAVrI4ONjWUVISSpBSDxzSPHKfJ6aBY2ek+0kfulrFc2UKcK4bLen
cr4IAGLX8uqVpfjanROAf/HKD2apEz1v7GqmzcE8IAfDey1bs/tj1AhTD/gdrhr5
E38QD0WqBQrhXzI+VngHzE+T0zSgbIeVsyzE5NxSYxThIv5R67ZDnFoiOSFNF3l7
8IvYRC5yNAUIOtXBbBJn3r8S8jrkqb6bP4C0MfTUTNUmRt+0XblNC8/ECGxfzEG+
w4jSbUmKEsNd7im7RXWRY8iWw97IjnUbKSCqtqu8lZKHeR8kYzprsvVEo0HDmTCD
-----END CERTIFICATE-----
issuing_ca          -----BEGIN CERTIFICATE-----
MIIDQTCCAimgAwIBAgIUC+9g/nAXPPV/VG6w50EnOAfc9+owDQYJKoZIhvcNAQEL
BQAwGjEYMBYGA1UEAxMPdmF1bHRyb24uY29uc3VsMB4XDTE4MDMwMjE4MTA0OVoX
DTE5MDMwMjE4MTExOVowGjEYMBYGA1UEAxMPdmF1bHRyb24uY29uc3VsMIIBIjAN
BgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsE9SqeKj7J5TPRonp8isauFcRP2x
P7I0erzRKEqdVejZF69kcdtFMVgJkDDv75rNzpNVlWGGCHSEbSJpvjV6Dv4vQROM
4u4923AgLNawt9lkrfZRD3gmPlN+EQ7x3jFwKaiOeyrRbLmnG6vt5slJrWpx3HfG
dnKIrN7yL0lq+ba+Z6IH0ScrV7HBxYQoLmVChVq2bSFlhs9F+vIY6nRpV99Z4Z/F
fAATKNoiVMyEMFscFciXoojBg1wxqRB3OycpsG5rn15fJBLaQkXHBY2Ge2RtoR4X
1Ad8KQ+BIdELSGb+1hJFRgI1Qya4Dn2r6S3cDex7HurOp9k97I3TFW9G1wIDAQAB
o38wfTAOBgNVHQ8BAf8EBAMCAQYwDwYDVR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQU
K0wt21kA6d8NejaOk87TYnT/OPAwHwYDVR0jBBgwFoAUK0wt21kA6d8NejaOk87T
YnT/OPAwGgYDVR0RBBMwEYIPdmF1bHRyb24uY29uc3VsMA0GCSqGSIb3DQEBCwUA
A4IBAQB8EXaxcll8A1xoOJIo4O+9kytst58CO51+7Tfh5AEybAlv1Mh0bHzwt3Wn
SoC+2z1bGwwilnPFlTMy+pExehBkVqAGyMzu/+0RqEhkFkBPFNUGnajraR7v11Es
errMmtQ723x/AC+zcVo0tvQCbZ1Dq6JjwLiHr6m0cNkdPETodmYveRhYdff8nMS5
KpD4w3R3vXS4gHa4nOuszjwq5B+OEwiY7QMdPPIpzhwZ0Ysou2SYguUq0hfyTtDO
6qFBV7yk0r+B7hjgxkU3pIoPUJa2GqIWR8VmIV4RZJSOJH6+eAkNjIjGvqjvCJeE
Ly9/0vipjKDAxIqEcvGttJzSYFLQ
-----END CERTIFICATE-----
private_key         -----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEA1igIdQgIajw9xiiJu+amzweX0sQZcMJwwjAG7tVtlKn5mlx5
wiJ8xjmXUtaIY4YiVXIiO7TnPUxFIwJ3Xd7mYQUzkUgHU3pNLUflZd27Q6JIkiLb
UNyDC6QHs64sA8pBZe0jqsUYeW9RcqRNCPdpCRPaoqmDVZFxLVhEoJiYqP2aKB7U
H8c/sF33XhBNamSEDovu8lweDKkVvzaNYeD5w/OXO5RjDhTL4Ct4xJ6d7fYhFdml
Ua77+3MCFo37AcwS4rGX0PZndci0xKQF08huUC7r8eEqHhZsgUowQndo87ox4KSc
U2kChUypMZ/DGsERGTHM2xZhr1gglzbnfRQ6EwIDAQABAoIBAQDNIzHesOAmqyfd
Pg2ZcPqOS86xtOhNq+OJD6pEcyrxgdQ3eaekP5bX5mi+kAO7mcwfnyGNod7zR7De
NUmUIKT7gJkB7EYgP4HYAwuJhVkRE02CtmLw1RmuN+SsyAUfaEk20m4c8YldITWa
pCmqkhwJ9vuyXsAQYi5QakHqt+Fb1ThIIsZydQj4GjUpmV0p4GJuOW5gLOICBx95
TOTzlmglegojz2drRVh7Y7Yx4Go2GM8yoiJN9IGltKr4fvC7dERhWjLGevTqXEzu
U3d2hMoNHejuD5AEBkDIteiir0I9KI5SG3ASL4IxBGugyD2WF/EubWmoEcHGDFWy
jCBFItrhAoGBAOGgL5gsva4P7OwtNW8HLEctWgIOuFW404iOr9sRYjZ2XoNBL5wE
NHBaUER4odLu4jciP/2O5BfQG9hlh7gDPVPHhWA05IzMHKpV7XjAEtXyhkRyYW54
z0YkL7YrU7C9GdYWPwVdr0Jinj0NW0hTfvalLEsRW/ZwfDWnCPZIvxLxAoGBAPL8
k0EQ83ob185vQd+/pdGP/eiwyGwFF8yqMp/+kn41B0QAGLHWuU3hFCVkyGlgfLUN
B2BSzBE948JENqhYdabQw7c71wUxuy5PxKY6zaxKfiIw1GT+1Qm7kuzbbUgX2eNT
cdfXWc/K5buYXM6YPdx1hQ9jUUpmDTNUfTB1zJVDAoGAUtT4JCnoyQpXtK00PLqp
asgfjznQOshMAIpBzW8oW05BjHZWADUa+1Rsu3Z+Em5Y5lzQmUnoO0XPszYzCT9H
OIa7VIKWlYopy+8X64i4YYtT97T2SBRaJCoMyhhF9VC3N32bTWEDgp+p8EgDBx6A
MhSZmkWZOXQ6ZYgZJjG21EECgYATZBCkSqQDhKFOOha5smObO7B5l1IHPMjPbm2n
0vsB012HEbLmzknvaxzedxJ/RlHtaOLDzxe18IhyglsSSCzraRGVV9Mq+PMFGRyK
X3r2WuOB+v+YJ7X8ltl8yW4JKM4clBYrsWXbbUe0Fs6hNgkJxN8fgT+FfmtjQ0TS
TzRKXQKBgGMJIWXTEGOtlPsXBt3NVm+OzwsLlcNS8i2NTWaHqiRiHUtPTAfUclDD
eymbdCfkhkVLURcAHQLlyUrjE4GT1ITqz2W4x1Ut8leY9EfuiAPTgbUEuTtdpfwG
Rsvuy/3r5ehaeCHh3SjHWf35XPozsgrHId2ZZgiVp+UdnCO517E4
-----END RSA PRIVATE KEY-----
private_key_type    rsa
serial_number       63:4a:6d:a1:67:f7:46:89:9c:6b:4a:2e:24:17:29:d6:21:fe:e2:0c
```
