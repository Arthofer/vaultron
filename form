#!/bin/sh
#
# This script is used to form Vaultron with Terraform
#
# Some of these would work only for pure POSIX
# shellcheck disable=SC2154
# shellcheck disable=SC2039
# shellcheck disable=SC2059
# shellcheck disable=SC1091

. ./skydome

TF_VAR_vault_custom_instance_count="${TF_VAR_vault_custom_instance_count:0}"

_form_message () {
cat << 'EOF'
You can now visit the Consul web UI at http://localhost:8500

or you can interact with vault and consul CLI utilities after
exporting the following environment variables in your shell:

export CONSUL_HTTP_ADDR="localhost:8500"
export VAULT_ADDR="http://localhost:8200"
EOF
}

###
### TerraFORM Vaultron!
###
_check_consul_version() {
  if [ ! -z "$TF_VAR_consul_version" ]; then
    USER_CONSUL_CONFIG="./red_lion/templates/consul_oss_server_config_${TF_VAR_consul_version}.tpl";
    if [ ! -f "$USER_CONSUL_CONFIG" ]; then
       echo "ðŸš«  Sorry, Vaultron does not support Consul version: ${TF_VAR_consul_version}";
       unset TF_VAR_consul_version;
       kill -INT $$
    fi
  fi
}

_check_vault_version() {
  if [ ! -z "$TF_VAR_vault_version" ]; then
    USER_VAULT_CONFIG="./black_lion/templates/vault_config_${TF_VAR_vault_version}.tpl";
    if [ ! -f "$USER_VAULT_CONFIG" ]; then
       echo "ðŸš«  Sorry, Vaultron does not support Vault version: ${TF_VAR_vault_version}";
       unset TF_VAR_vault_version;
       kill -INT $$
    fi
  fi
}

_check_custom_binary() {
  if [ "$TF_VAR_vault_custom_instance_count" -gt 0 ]; then
    if [ ! -f ./custom/"$1" ]; then
      _logmsg alert "Vaultron cannot form! You specified a custom binary to use, but ./custom/$1 was not found."
      exit 1
    fi
  fi
}

if [ -z "$(command -v terraform)" ]; then
  _logmsg alert "Vaultron cannot form! Could not locate terraform command."
  _logmsg info "Get Terraform from: https://www.terraform.io/downloads.html"
  exit 1
fi

_check_custom_binary vault

_logmsg greeting "Form Vaultron! ..."

if ! _init; then
  _logmsg alert "Vaultron cannot form! terraform init output from $init_out:"
  cat "$init_out"
  exit 1
fi

CURRENT_CONSUL_VERSION="$(echo "var.consul_version" | terraform console)"
CURRENT_VAULT_VERSION="$(echo "var.vault_version" | terraform console)"

export TF_VAR_consul_version=${TF_VAR_consul_version:-$CURRENT_CONSUL_VERSION}
export TF_VAR_vault_version=${TF_VAR_vault_version:-$CURRENT_VAULT_VERSION}

_check_vault_version
_check_consul_version

_logmsg greeting "Vault Docker image version: ${TF_VAR_consul_version}"

if [ "$TF_VAR_vault_custom_instance_count" -gt 0 ]; then
  _logmsg greeting "Vault Docker image version: ${TF_VAR_vault_version} ${txtrst}(${txtblu}custom binary${txtrst})"
else
  _logmsg greeting "Vault Docker image version: ${TF_VAR_vault_version}"
fi

plan_file=./tfstate/vaultron-$(date -u "+%Y-%m-%dT%H:%M:%SZ").plan

if ! _plan "${plan_file}"; then
  _logmsg alert "Vaultron cannot form! terraform plan output from $plan_out:"
  cat "$plan_out"
  exit 1
fi

if ! _apply "${plan_file}"; then
  _logmsg alert "Vaultron cannot form! terraform apply output from $apply_out:"
  cat "$apply_out"
  exit 1
fi

rm -f "${plan_file}"
_logmsg success "Vaultron formed!"
_form_message
